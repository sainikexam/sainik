<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SainikPrep ‚Äî AISSEE Quiz & Notes</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>

<!-- FIREBASE -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc,collection,addDoc,getDocs,deleteDoc,updateDoc,query,orderBy,arrayUnion,where}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const firebaseConfig={apiKey:"AIzaSyDAEMXwHWghLyBrzzrz9nn6hx6_EUfK-20",authDomain:"aissee-quiz.firebaseapp.com",projectId:"aissee-quiz",storageBucket:"aissee-quiz.firebasestorage.app",messagingSenderId:"1092597007967",appId:"1:1092597007967:web:93958b401b31167f4fbdea"};
const app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app);
window._FB={auth,db,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged,doc,setDoc,getDoc,collection,addDoc,getDocs,deleteDoc,updateDoc,query,orderBy,arrayUnion,where};
onAuthStateChanged(auth,async u=>{if(u){const s=await getDoc(doc(db,'users',u.uid));if(s.exists()){window.currentUser={uid:u.uid,email:u.email,...s.data()};document.getElementById('adminNavBtn').style.display=window.currentUser.isAdmin?'':'none';document.getElementById('userInfo').textContent=window.currentUser.name;hideLoader();showPage('home');loadBookmarks()}}else{window.currentUser=null;hideLoader();showPage('login')}});
</script>

<style>
:root{--olive:#4a5c2f;--olive-dark:#2e3a1c;--olive-light:#6b7f44;--khaki:#c8b87a;--khaki-light:#e8d9a8;--cream:#f5f0e8;--sand:#ede3cc;--red:#c0392b;--green:#27ae60;--blue:#2980b9;--text:#1a2010;--text-muted:#6b7355;--white:#fff;--shadow:0 4px 24px rgba(0,0,0,.12);--shadow-lg:0 8px 40px rgba(0,0,0,.18)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Nunito',sans-serif;background:var(--cream);color:var(--text);min-height:100vh;background-image:radial-gradient(ellipse at 20% 0%,rgba(74,92,47,.08) 0%,transparent 60%),radial-gradient(ellipse at 80% 100%,rgba(200,184,122,.15) 0%,transparent 60%)}

/* LOADER */
#loader{position:fixed;inset:0;background:var(--olive-dark);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:1.2rem}
.loader-logo{font-family:'Rajdhani',sans-serif;font-size:2rem;font-weight:700;color:var(--white);letter-spacing:3px}.loader-logo span{color:var(--khaki)}
.spinner{width:36px;height:36px;border:3px solid rgba(255,255,255,.2);border-top-color:var(--khaki);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loader.hidden{display:none}

/* HEADER */
.header{background:var(--olive-dark);color:var(--white);padding:0 1rem;display:flex;align-items:center;justify-content:space-between;height:56px;position:sticky;top:0;z-index:100;box-shadow:0 2px 16px rgba(0,0,0,.3)}
.logo{font-family:'Rajdhani',sans-serif;font-size:1.4rem;font-weight:700;letter-spacing:2px;display:flex;align-items:center;gap:6px;white-space:nowrap}
.logo-star{color:var(--khaki);font-size:1rem}
.header-nav{display:flex;align-items:center;gap:.4rem;flex-wrap:wrap}
.nav-btn{background:0 0;border:1px solid rgba(255,255,255,.2);color:var(--white);padding:4px 12px;border-radius:6px;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.78rem;font-weight:600;transition:all .2s;white-space:nowrap}
.nav-btn:hover{background:rgba(255,255,255,.1);border-color:var(--khaki)}
.nav-btn.active{background:var(--olive-light);border-color:var(--olive-light)}
.user-chip{font-size:.78rem;color:var(--khaki);font-weight:600;margin-right:.2rem}

/* PAGES */
.page{display:none;animation:fadeIn .4s ease}.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* AUTH */
.auth-wrap{min-height:calc(100vh - 56px);display:flex;align-items:center;justify-content:center;padding:2rem}
.auth-card{background:var(--white);border-radius:20px;padding:2.5rem;width:100%;max-width:400px;box-shadow:var(--shadow-lg);border-top:4px solid var(--olive)}
.auth-title{font-family:'Rajdhani',sans-serif;font-size:1.8rem;font-weight:700;color:var(--olive-dark);margin-bottom:.3rem}
.auth-sub{color:var(--text-muted);font-size:.88rem;margin-bottom:1.5rem}
.form-group{margin-bottom:1rem}
.form-label{display:block;font-size:.75rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-muted);margin-bottom:5px}
.form-input{width:100%;padding:10px 14px;border:2px solid var(--sand);border-radius:10px;font-family:'Nunito',sans-serif;font-size:.9rem;background:var(--cream);color:var(--text);transition:border-color .2s}
.form-input:focus{outline:0;border-color:var(--olive-light);background:var(--white)}
textarea.form-input{resize:vertical;min-height:80px}
.btn-primary{width:100%;padding:12px;background:var(--olive);color:var(--white);border:none;border-radius:10px;font-family:'Nunito',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s;margin-top:.5rem}
.btn-primary:hover{background:var(--olive-dark);transform:translateY(-1px);box-shadow:0 4px 16px rgba(74,92,47,.4)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
.auth-switch{text-align:center;margin-top:1rem;font-size:.85rem;color:var(--text-muted)}.auth-switch a{color:var(--olive);font-weight:700;cursor:pointer}
.msg-error{color:var(--red);font-size:.83rem;margin-top:.5rem;display:none;padding:8px 12px;background:#fdecea;border-radius:8px}.msg-error.show{display:block}

/* HOME */
.home-wrap{max-width:1100px;margin:0 auto;padding:1.5rem}
.welcome-banner{background:linear-gradient(135deg,var(--olive-dark),var(--olive-light));color:var(--white);border-radius:20px;padding:1.8rem 2rem;margin-bottom:1.5rem;position:relative;overflow:hidden}
.welcome-banner::before{content:'‚òÖ';position:absolute;right:1.5rem;top:50%;transform:translateY(-50%);font-size:5rem;opacity:.06}
.welcome-name{font-family:'Rajdhani',sans-serif;font-size:1.7rem;font-weight:700;letter-spacing:1px}
.welcome-sub{opacity:.8;margin-top:4px;font-size:.88rem}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:2rem}
.stat-card{background:var(--white);border-radius:14px;padding:1rem;text-align:center;box-shadow:var(--shadow)}
.stat-val{font-family:'Rajdhani',sans-serif;font-size:2rem;font-weight:700;color:var(--olive)}
.stat-lbl{font-size:.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}

/* MODE TABS (Quiz / Notes toggle on home) */
.mode-tabs{display:flex;gap:0;margin-bottom:1.5rem;background:var(--sand);border-radius:14px;padding:4px}
.mode-tab{flex:1;padding:12px;border:none;border-radius:11px;background:0 0;font-family:'Rajdhani',sans-serif;font-size:1.05rem;font-weight:700;cursor:pointer;color:var(--text-muted);transition:all .25s;text-align:center}
.mode-tab.active{background:var(--white);color:var(--olive-dark);box-shadow:var(--shadow)}
.mode-tab:hover:not(.active){color:var(--olive)}
.mode-content{display:none}.mode-content.active{display:block;animation:fadeIn .3s ease}

/* SUBJECT GRID */
.section-title{font-family:'Rajdhani',sans-serif;font-size:1.2rem;font-weight:700;color:var(--olive-dark);margin-bottom:1rem;letter-spacing:.5px}
.subject-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:.8rem;margin-bottom:1.5rem}
.subject-card{background:var(--white);border-radius:14px;padding:1.2rem;cursor:pointer;box-shadow:var(--shadow);border:2px solid transparent;transition:all .25s;text-align:center}
.subject-card:hover{border-color:var(--olive-light);transform:translateY(-2px);box-shadow:var(--shadow-lg)}
.subject-card.selected{border-color:var(--olive);background:var(--olive-dark);color:var(--white)}
.subject-icon{font-size:1.8rem;margin-bottom:.3rem}
.subject-name{font-family:'Rajdhani',sans-serif;font-size:.95rem;font-weight:700}
.subject-count{font-size:.72rem;color:var(--text-muted);margin-top:2px}
.subject-card.selected .subject-count{color:rgba(255,255,255,.7)}

/* CLASS SELECTOR */
.class-selector{display:flex;gap:.8rem;margin-bottom:1.2rem;justify-content:center}
.class-btn{padding:10px 28px;border:3px solid var(--sand);border-radius:12px;background:var(--white);font-family:'Rajdhani',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;color:var(--text)}
.class-btn:hover{border-color:var(--olive-light)}
.class-btn.active{border-color:var(--olive);background:var(--olive);color:var(--white)}

/* QUIZ CONFIG */
.drill-row{display:flex;gap:.8rem;flex-wrap:wrap;align-items:center;margin-bottom:1.5rem}
.select-box{padding:10px 14px;border:2px solid var(--sand);border-radius:10px;background:var(--white);font-family:'Nunito',sans-serif;font-size:.88rem;color:var(--text);flex:1;min-width:140px}
.select-box:focus{outline:0;border-color:var(--olive)}
.btn-start{padding:10px 28px;background:var(--olive);color:var(--white);border:none;border-radius:10px;font-family:'Rajdhani',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-start:hover{background:var(--olive-dark);transform:translateY(-1px)}
.btn-start:disabled{opacity:.4;cursor:not-allowed;transform:none}

/* QUIZ PAGE */
.quiz-wrap{max-width:740px;margin:0 auto;padding:1.5rem}
.quiz-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem}
.quiz-breadcrumb{font-size:.82rem;color:var(--text-muted)}
.quiz-progress-wrap{display:flex;align-items:center;gap:.8rem}
.quiz-progress-text{font-size:.85rem;font-weight:700}
.timer-chip{background:var(--olive);color:var(--white);padding:4px 14px;border-radius:20px;font-family:'Rajdhani',sans-serif;font-size:1.1rem;font-weight:700;min-width:48px;text-align:center}
.timer-chip.danger{background:var(--red);animation:pulse .5s infinite alternate}
@keyframes pulse{to{opacity:.7}}
.progress-bar-track{height:5px;background:var(--sand);border-radius:3px;margin-bottom:1.5rem;overflow:hidden}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--olive-light),var(--khaki));border-radius:3px;transition:width .4s ease}
.question-card{background:var(--white);border-radius:18px;padding:2rem;box-shadow:var(--shadow-lg);margin-bottom:1.5rem}
.q-num{font-size:.78rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:.6rem}
.q-text{font-size:1.05rem;line-height:1.7;font-weight:600;margin-bottom:1.5rem;position:relative}
.options-list{display:flex;flex-direction:column;gap:.6rem}
.option-btn{display:flex;align-items:center;gap:12px;width:100%;padding:13px 16px;border:2px solid var(--sand);border-radius:12px;background:var(--white);font-family:'Nunito',sans-serif;font-size:.92rem;cursor:pointer;transition:all .2s;text-align:left}
.option-btn:hover:not(.correct):not(.wrong):not(.disabled){border-color:var(--olive-light);background:rgba(74,92,47,.04)}
.option-key{width:32px;height:32px;border-radius:8px;background:var(--cream);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.85rem;flex-shrink:0;color:var(--text-muted)}
.option-btn.correct{border-color:var(--green);background:rgba(39,174,96,.08)}.option-btn.correct .option-key{background:var(--green);color:var(--white)}
.option-btn.wrong{border-color:var(--red);background:rgba(192,57,43,.06)}.option-btn.wrong .option-key{background:var(--red);color:var(--white)}
.option-btn.disabled{pointer-events:none;opacity:.7}
.explanation-box{background:var(--cream);border-left:4px solid var(--olive);border-radius:0 12px 12px 0;padding:1rem 1.3rem;margin-top:1.2rem;font-size:.88rem;line-height:1.6;display:none}
.explanation-box.show{display:block;animation:fadeIn .3s}
.explanation-label{font-weight:700;color:var(--olive);font-size:.78rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:.3rem}
.next-btn{display:none;width:100%;padding:14px;background:var(--olive);color:var(--white);border:none;border-radius:12px;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s}
.next-btn.show{display:block}.next-btn:hover{background:var(--olive-dark)}
.bookmark-btn{position:absolute;top:-4px;right:0;background:none;border:none;font-size:1.3rem;cursor:pointer;opacity:.5;transition:opacity .2s}.bookmark-btn:hover,.bookmark-btn.bookmarked{opacity:1}

/* RESULT */
.result-wrap{max-width:600px;margin:0 auto;padding:1.5rem}
.result-card{background:var(--white);border-radius:20px;padding:2.5rem;text-align:center;box-shadow:var(--shadow-lg)}
.result-score-ring{width:160px;height:160px;border-radius:50%;margin:0 auto 1.5rem;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;border:8px solid var(--sand)}
.result-score-ring.excellent{border-color:var(--green)}.result-score-ring.good{border-color:var(--olive)}.result-score-ring.avg{border-color:var(--khaki)}.result-score-ring.poor{border-color:var(--red)}
.result-pct{font-size:3rem;font-weight:700;line-height:1}.result-label{font-size:.8rem;color:var(--text-muted);text-transform:uppercase}
.result-title{font-family:'Rajdhani',sans-serif;font-size:1.6rem;font-weight:700;color:var(--olive-dark);margin-bottom:1rem}
.result-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:1.5rem}
.r-stat{text-align:center}.r-stat-val{font-size:1.5rem;font-family:'Rajdhani',sans-serif;font-weight:700}.r-stat-lbl{font-size:.72rem;color:var(--text-muted);text-transform:uppercase}
.r-stat-val.green{color:var(--green)}.r-stat-val.red{color:var(--red)}.r-stat-val.orange{color:#d4a006}
.result-actions{display:flex;gap:.8rem;justify-content:center;flex-wrap:wrap}
.result-actions .btn-start{font-size:.88rem;padding:10px 22px}

/* NOTES BROWSE */
.chapter-list{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.5rem}
.chapter-card{background:var(--white);border-radius:12px;padding:.9rem 1.2rem;cursor:pointer;box-shadow:var(--shadow);display:flex;justify-content:space-between;align-items:center;transition:all .2s;border-left:4px solid var(--olive-light)}
.chapter-card:hover{transform:translateX(4px);box-shadow:var(--shadow-lg);border-left-color:var(--olive)}
.chapter-name{font-weight:700;font-size:.92rem}.chapter-meta{font-size:.75rem;color:var(--text-muted);margin-top:2px}
.chapter-count{font-family:'Rajdhani',sans-serif;font-size:1rem;font-weight:700;color:var(--olive);background:var(--cream);padding:3px 10px;border-radius:20px}
.topic-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.8rem;margin-bottom:1.5rem}
.topic-card{background:var(--white);border-radius:12px;padding:1rem 1.2rem;cursor:pointer;box-shadow:var(--shadow);transition:all .2s;border-top:3px solid var(--khaki)}
.topic-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);border-top-color:var(--olive)}
.topic-name{font-family:'Rajdhani',sans-serif;font-size:1rem;font-weight:700;color:var(--olive-dark)}
.topic-updated{font-size:.7rem;color:var(--text-muted);margin-top:3px}
.breadcrumbs{display:flex;align-items:center;gap:.4rem;margin-bottom:1.2rem;font-size:.82rem;flex-wrap:wrap}
.bc-item{color:var(--olive);cursor:pointer;font-weight:600}.bc-item:hover{text-decoration:underline}
.bc-sep{color:var(--text-muted)}.bc-cur{color:var(--text);font-weight:700}

/* NOTE READER */
.note-reader{max-width:860px;margin:0 auto;padding:1.5rem}
.note-card{background:var(--white);border-radius:20px;padding:2rem 2.5rem;box-shadow:var(--shadow-lg);border-left:5px solid var(--olive);margin-bottom:1.5rem}
.note-title{font-family:'Rajdhani',sans-serif;font-size:1.7rem;font-weight:700;color:var(--olive-dark);margin-bottom:.3rem}
.note-meta-bar{display:flex;gap:.8rem;margin-bottom:1.2rem;flex-wrap:wrap;padding-bottom:.8rem;border-bottom:2px solid var(--sand)}
.note-meta-item{font-size:.75rem;color:var(--text-muted);display:flex;align-items:center;gap:3px}
.note-content{font-size:.95rem;line-height:1.8;color:var(--text)}
.note-content h1{font-family:'Rajdhani',sans-serif;font-size:1.5rem;font-weight:700;color:var(--olive-dark);margin:1.3rem 0 .7rem;padding-bottom:.3rem;border-bottom:2px solid var(--sand)}
.note-content h2{font-family:'Rajdhani',sans-serif;font-size:1.25rem;font-weight:700;color:var(--olive);margin:1.2rem 0 .5rem}
.note-content h3{font-family:'Rajdhani',sans-serif;font-size:1.05rem;font-weight:700;color:var(--olive-light);margin:.9rem 0 .4rem}
.note-content p{margin-bottom:.7rem}
.note-content ul,.note-content ol{margin:0 0 .8rem 1.5rem}.note-content li{margin-bottom:.3rem}
.note-content blockquote{border-left:4px solid var(--khaki);background:var(--cream);padding:.7rem 1rem;margin:.8rem 0;border-radius:0 10px 10px 0;font-style:italic;color:var(--text-muted)}
.note-content code{background:var(--sand);padding:2px 5px;border-radius:4px;font-size:.85rem;font-family:monospace}
.note-content pre{background:var(--olive-dark);color:var(--khaki-light);padding:1rem;border-radius:12px;overflow-x:auto;margin:.8rem 0;font-size:.83rem}
.note-content pre code{background:none;padding:0;color:inherit}
.note-content table{width:100%;border-collapse:collapse;margin:.8rem 0;font-size:.88rem}
.note-content table th{background:var(--olive);color:var(--white);padding:8px 12px;text-align:left;font-size:.78rem;text-transform:uppercase;letter-spacing:.5px}
.note-content table td{padding:8px 12px;border-bottom:1px solid var(--sand)}
.note-content table tr:hover{background:var(--cream)}
.note-content .katex-display{margin:.8rem 0;overflow-x:auto}
.note-content hr{border:none;border-top:2px solid var(--sand);margin:1.2rem 0}
.box-important,.box-tip,.box-warning{padding:.8rem 1.1rem;border-radius:12px;margin:.8rem 0;font-size:.88rem}
.box-important{background:#fdecea;border-left:4px solid var(--red);color:#7a1b1b}
.box-tip{background:#eafaf1;border-left:4px solid var(--green);color:#145a32}
.box-warning{background:#fff3cd;border-left:4px solid #d4a006;color:#856404}
.reading-progress{position:fixed;top:56px;left:0;width:0%;height:3px;background:linear-gradient(90deg,var(--olive-light),var(--khaki));z-index:99;transition:width .1s}

/* SEARCH */
.search-bar{display:flex;gap:.5rem;margin-bottom:1.2rem}
.search-input{flex:1;padding:10px 14px;border:2px solid var(--sand);border-radius:12px;font-family:'Nunito',sans-serif;font-size:.9rem;background:var(--white)}
.search-input:focus{outline:0;border-color:var(--olive)}
.search-result-card{background:var(--white);padding:.9rem 1.2rem;border-radius:12px;box-shadow:var(--shadow);cursor:pointer;transition:all .2s;border-left:3px solid var(--khaki);margin-bottom:.5rem}
.search-result-card:hover{transform:translateX(4px);border-left-color:var(--olive)}
.sr-title{font-weight:700;font-size:.92rem}.sr-path{font-size:.75rem;color:var(--text-muted);margin-top:2px}.sr-preview{font-size:.8rem;color:var(--text-muted);margin-top:.3rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.sr-type{display:inline-block;padding:2px 8px;border-radius:10px;font-size:.68rem;font-weight:700;text-transform:uppercase;margin-left:6px}
.sr-type.note{background:rgba(74,92,47,.12);color:var(--olive)}.sr-type.quiz{background:rgba(200,184,122,.3);color:#7a6020}

/* HISTORY */
.history-wrap{max-width:800px;margin:0 auto;padding:1.5rem}
.history-card{background:var(--white);border-radius:16px;padding:1.5rem;box-shadow:var(--shadow)}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem}
.history-title{font-family:'Rajdhani',sans-serif;font-size:1.4rem;font-weight:700;color:var(--olive-dark)}
.history-filters{display:flex;gap:.5rem}
.history-filters select{padding:6px 10px;border:2px solid var(--sand);border-radius:8px;font-family:'Nunito',sans-serif;font-size:.82rem}
.history-row{display:flex;align-items:center;gap:1rem;padding:.8rem;border-bottom:1px solid var(--sand);transition:background .2s}
.history-row:hover{background:var(--cream)}
.history-date{text-align:center;min-width:44px}.history-date-day{font-family:'Rajdhani',sans-serif;font-size:1.3rem;font-weight:700;color:var(--olive)}.history-date-month{font-size:.65rem;text-transform:uppercase;color:var(--text-muted)}
.history-info{flex:1}.history-test-name{font-weight:700;font-size:.88rem}.history-test-details{font-size:.75rem;color:var(--text-muted)}
.history-score-val{font-family:'Rajdhani',sans-serif;font-size:1.2rem;font-weight:700;text-align:right}
.history-score-sub{font-size:.7rem;color:var(--text-muted);text-align:right}
.history-score-val.excellent{color:var(--green)}.history-score-val.good{color:var(--olive)}.history-score-val.average{color:#d4a006}.history-score-val.poor{color:var(--red)}

/* LEADERBOARD */
.lb-wrap{max-width:700px;margin:0 auto;padding:1.5rem}
.lb-card{background:var(--white);border-radius:16px;padding:1.5rem;box-shadow:var(--shadow)}
.lb-header{margin-bottom:1rem}.lb-title{font-family:'Rajdhani',sans-serif;font-size:1.4rem;font-weight:700;color:var(--olive-dark);margin-bottom:.5rem}
.lb-filter{display:flex;gap:.3rem;flex-wrap:wrap}
.lb-filter-btn{padding:5px 12px;border:2px solid var(--sand);background:var(--white);border-radius:20px;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:'Nunito',sans-serif}
.lb-filter-btn:hover{border-color:var(--olive-light)}.lb-filter-btn.active{background:var(--olive);color:var(--white);border-color:var(--olive)}
.lb-row{display:flex;align-items:center;padding:.7rem .5rem;border-bottom:1px solid var(--sand);gap:.8rem}
.lb-rank{font-family:'Rajdhani',sans-serif;font-size:1.2rem;font-weight:700;min-width:36px;text-align:center;color:var(--olive)}
.lb-name{flex:1;font-weight:600;font-size:.9rem}.lb-score{font-family:'Rajdhani',sans-serif;font-size:1.1rem;font-weight:700;color:var(--olive)}
.lb-empty{text-align:center;padding:2rem;color:var(--text-muted)}

/* ADMIN */
.admin-wrap{max-width:960px;margin:0 auto;padding:1.5rem}
.admin-form{background:var(--white);border-radius:16px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1rem}
.admin-form h3{font-family:'Rajdhani',sans-serif;font-size:1.2rem;font-weight:700;color:var(--olive-dark);margin-bottom:1rem;padding-bottom:.5rem;border-bottom:2px solid var(--sand)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:.8rem}
.form-row.one{grid-template-columns:1fr}
.btn-sm{padding:8px 18px;background:var(--olive);color:var(--white);border:none;border-radius:8px;font-family:'Nunito',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s}
.btn-sm:hover{background:var(--olive-dark)}.btn-sm:disabled{opacity:.5;cursor:not-allowed}
.btn-danger-sm{padding:5px 12px;background:#fdecea;color:var(--red);border:1px solid #f5c6c6;border-radius:8px;font-family:'Nunito',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer}
.btn-danger-sm:hover{background:var(--red);color:var(--white)}
.btn-sec{padding:8px 18px;background:transparent;border:2px solid var(--olive);color:var(--olive);border-radius:8px;font-family:'Nunito',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer}
.btn-sec:hover{background:var(--olive);color:var(--white)}
.admin-tabs{display:flex;gap:.3rem;margin-bottom:1.2rem;background:var(--sand);border-radius:12px;padding:3px;flex-wrap:wrap}
.admin-tab{flex:1;padding:9px 6px;border:none;border-radius:9px;background:0 0;font-family:'Nunito',sans-serif;font-size:.8rem;font-weight:700;cursor:pointer;color:var(--text-muted);transition:all .2s;min-width:80px;text-align:center}
.admin-tab.active{background:var(--white);color:var(--olive-dark);box-shadow:var(--shadow)}
.admin-panel{display:none}.admin-panel.active{display:block;animation:fadeIn .3s}

/* EDITOR */
.editor-wrap{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-top:.8rem;min-height:350px}
.editor-pane{display:flex;flex-direction:column}
.editor-pane-label{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:4px}
.md-editor{width:100%;flex:1;min-height:300px;padding:12px;border:2px solid var(--sand);border-radius:12px;font-family:monospace;font-size:.85rem;line-height:1.6;background:var(--cream);color:var(--text);resize:vertical}
.md-editor:focus{outline:0;border-color:var(--olive-light);background:var(--white)}
.preview-pane{border:2px solid var(--sand);border-radius:12px;padding:1rem 1.2rem;background:var(--white);overflow-y:auto;max-height:450px}
.tb{display:flex;gap:.2rem;margin-bottom:.4rem;flex-wrap:wrap}
.tb-btn{padding:3px 8px;background:var(--sand);border:none;border-radius:5px;cursor:pointer;font-size:.8rem;transition:all .15s}.tb-btn:hover{background:var(--khaki)}

/* TABLE (admin) */
.q-list-table,.notes-list-table{width:100%;border-collapse:collapse;margin-top:.5rem}
.q-list-table th,.notes-list-table th{text-align:left;padding:8px 10px;font-size:.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);border-bottom:2px solid var(--sand)}
.q-list-table td,.notes-list-table td{padding:10px;border-bottom:1px solid var(--sand);font-size:.85rem;vertical-align:middle}
.badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:.7rem;font-weight:700;text-transform:uppercase}
.badge-olive{background:rgba(74,92,47,.12);color:var(--olive-dark)}.badge-khaki{background:rgba(200,184,122,.3);color:#7a6020}
.radio-group{display:flex;gap:1rem;flex-wrap:wrap}
.radio-group label{display:flex;align-items:center;gap:5px;font-size:.88rem;cursor:pointer}

/* TOAST */
.success-toast{position:fixed;bottom:2rem;right:2rem;background:var(--olive-dark);color:var(--white);padding:.8rem 1.3rem;border-radius:12px;font-weight:700;font-size:.85rem;transform:translateY(100px);opacity:0;transition:all .4s cubic-bezier(.34,1.56,.64,1);z-index:999;box-shadow:var(--shadow-lg)}.success-toast.show{transform:translateY(0);opacity:1}
.empty-state{text-align:center;padding:2.5rem;color:var(--text-muted)}.empty-icon{font-size:2.5rem;margin-bottom:.6rem}

/* BOOKMARKS */
.bookmarks-wrap{max-width:800px;margin:0 auto;padding:1.5rem}
.bookmark-card{background:var(--white);border-radius:12px;padding:1.2rem;box-shadow:var(--shadow);margin-bottom:.8rem}
.bm-question{font-weight:700;font-size:.92rem;margin-bottom:.6rem}
.bm-options{display:flex;flex-direction:column;gap:.3rem;margin-bottom:.5rem}
.bm-opt{padding:6px 10px;border-radius:8px;font-size:.85rem;background:var(--cream)}
.bm-opt.correct{background:rgba(39,174,96,.1);color:var(--green);font-weight:700;border:1px solid rgba(39,174,96,.3)}
.bm-meta{font-size:.75rem;color:var(--text-muted)}.bm-remove{float:right;cursor:pointer;color:var(--red);font-weight:700;font-size:.8rem}

@media(max-width:768px){
  .header-nav{gap:.2rem}.nav-btn{padding:3px 8px;font-size:.72rem}
  .editor-wrap{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}
  .note-card{padding:1.3rem 1rem}.home-wrap{padding:1rem}
  .stats-row{grid-template-columns:repeat(3,1fr);gap:.5rem}
  .stat-card{padding:.7rem}.stat-val{font-size:1.5rem}
  .drill-row{flex-direction:column}.select-box{min-width:100%}
  .mode-tab{font-size:.9rem;padding:10px 6px}
}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--cream)}::-webkit-scrollbar-thumb{background:var(--olive-light);border-radius:3px}
</style>
</head>
<body>

<div id="loader">
  <div class="loader-logo">‚òÖ SAINIK<span>PREP</span></div>
  <div class="spinner"></div>
</div>
<div class="reading-progress" id="readingProgress"></div>

<header class="header">
  <div class="logo"><span class="logo-star">‚òÖ</span>SainikPrep</div>
  <div class="header-nav">
    <span class="user-chip" id="userInfo"></span>
    <button class="nav-btn" onclick="showPage('home')">üè† Home</button>
    <button class="nav-btn" onclick="showPage('search')">üîç</button>
    <button class="nav-btn" onclick="showPage('history')">üìä</button>
    <button class="nav-btn" onclick="showPage('bookmarks')">üîñ</button>
    <button class="nav-btn" onclick="showPage('leaderboard')">üèÖ</button>
    <button class="nav-btn" id="adminNavBtn" style="display:none" onclick="showPage('admin')">üõ°Ô∏è</button>
    <button class="nav-btn" onclick="window._FB.signOut(window._FB.auth).then(()=>location.reload())">‚Ü™</button>
  </div>
</header>
<div class="success-toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
<div class="page active" id="page-login">
  <div class="auth-wrap"><div class="auth-card">
    <div class="auth-title">‚òÖ SainikPrep</div>
    <div class="auth-sub">Login to access AISSEE practice & notes</div>
    <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="loginEmail" type="email" placeholder="your@email.com"/></div>
    <div class="form-group"><label class="form-label">Password</label><input class="form-input" id="loginPass" type="password" placeholder="Enter password" onkeydown="if(event.key==='Enter')doLogin()"/></div>
    <div class="msg-error" id="loginErr"></div>
    <button class="btn-primary" id="loginBtn" onclick="doLogin()">Login ‚Üí</button>
    <div class="auth-switch">Don't have an account? <a onclick="switchAuth('register')">Register</a></div>
  </div></div>
</div>

<!-- ‚ïê‚ïê‚ïê REGISTER ‚ïê‚ïê‚ïê -->
<div class="page" id="page-register">
  <div class="auth-wrap"><div class="auth-card">
    <div class="auth-title">Join SainikPrep</div>
    <div class="auth-sub">Create your free account</div>
    <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="regName" type="text" placeholder="Your name"/></div>
    <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="regEmail" type="email" placeholder="your@email.com"/></div>
    <div class="form-group"><label class="form-label">Password</label><input class="form-input" id="regPass" type="password" placeholder="Min 6 characters" onkeydown="if(event.key==='Enter')doRegister()"/></div>
    <div class="msg-error" id="regErr"></div>
    <button class="btn-primary" id="regBtn" onclick="doRegister()">Create Account ‚Üí</button>
    <div class="auth-switch">Have an account? <a onclick="switchAuth('login')">Login</a></div>
  </div></div>
</div>

<!-- ‚ïê‚ïê‚ïê HOME (Quiz + Notes combined) ‚ïê‚ïê‚ïê -->
<div class="page" id="page-home">
  <div class="home-wrap">
    <div class="welcome-banner">
      <div class="welcome-name" id="welcomeName">Welcome, Cadet! üéñÔ∏è</div>
      <div class="welcome-sub">AISSEE preparation ‚Äî Practice Tests & Study Notes in one place</div>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-val" id="statTests">‚Äì</div><div class="stat-lbl">Tests</div></div>
      <div class="stat-card"><div class="stat-val" id="statAvg">‚Äì</div><div class="stat-lbl">Avg Score</div></div>
      <div class="stat-card"><div class="stat-val" id="statBest">‚Äì</div><div class="stat-lbl">Best</div></div>
    </div>

    <!-- MODE TOGGLE: Quiz vs Notes -->
    <div class="mode-tabs">
      <button class="mode-tab active" onclick="setMode('quiz',this)">üìù Practice Quiz</button>
      <button class="mode-tab" onclick="setMode('notes',this)">üìñ Study Notes</button>
    </div>

    <!-- QUIZ MODE -->
    <div class="mode-content active" id="mode-quiz">
      <div class="section-title">üìö Select Subject</div>
      <div class="subject-grid" id="subjectGrid"></div>
      <div class="section-title">‚öôÔ∏è Configure Test</div>
      <div class="drill-row">
        <select class="select-box" id="chapterSel" onchange="updateTopics()"><option value="">‚Äî Chapter ‚Äî</option></select>
        <select class="select-box" id="topicSel"><option value="">‚Äî All Topics ‚Äî</option></select>
        <select class="select-box" id="countSel" style="max-width:140px"><option value="5">5 Q</option><option value="10" selected>10 Q</option><option value="20">20 Q</option><option value="30">30 Q</option></select>
        <button class="btn-start" id="startBtn" onclick="startQuiz()" disabled>‚ñ∂ Start Test</button>
      </div>
    </div>

    <!-- NOTES MODE -->
    <div class="mode-content" id="mode-notes">
      <div class="class-selector" id="classSelector"></div>
      <div id="browseContent"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê QUIZ ‚ïê‚ïê‚ïê -->
<div class="page" id="page-quiz">
  <div class="quiz-wrap">
    <div class="quiz-meta">
      <div class="quiz-breadcrumb" id="quizBreadcrumb">Subject ‚Ä∫ Chapter</div>
      <div class="quiz-progress-wrap">
        <div class="quiz-progress-text" id="quizProgressText">1/10</div>
        <div class="timer-chip" id="timerDisplay">90</div>
      </div>
    </div>
    <div class="progress-bar-track"><div class="progress-bar-fill" id="progressFill" style="width:0"></div></div>
    <div class="question-card">
      <div class="q-num" id="qNum">Question 1 of 10</div>
      <div class="q-text" id="qText"></div>
      <div class="options-list" id="optionsList"></div>
      <div class="explanation-box" id="explanationBox"><div class="explanation-label">üí° Explanation</div><div id="explanationText"></div></div>
    </div>
    <button class="next-btn" id="nextBtn" onclick="nextQuestion()">Next Question ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê RESULT ‚ïê‚ïê‚ïê -->
<div class="page" id="page-result">
  <div class="result-wrap">
    <div class="result-card">
      <div class="result-score-ring" id="resultRing"><div class="result-pct" id="resultPct">0%</div><div class="result-label">Score</div></div>
      <div class="result-title" id="resultTitle">Good job!</div>
      <div class="result-stats">
        <div class="r-stat"><div class="r-stat-val green" id="rCorrect">0</div><div class="r-stat-lbl">Correct</div></div>
        <div class="r-stat"><div class="r-stat-val red" id="rWrong">0</div><div class="r-stat-lbl">Wrong</div></div>
        <div class="r-stat"><div class="r-stat-val orange" id="rTimeout">0</div><div class="r-stat-lbl">Timed Out</div></div>
      </div>
      <div class="result-actions">
        <button class="btn-start" onclick="showPage('home')">‚Üê Home</button>
        <button class="btn-start" onclick="startQuiz()">üîÑ Retry</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê NOTE READER ‚ïê‚ïê‚ïê -->
<div class="page" id="page-reader">
  <div class="note-reader" id="noteReader"></div>
</div>

<!-- ‚ïê‚ïê‚ïê SEARCH (Combined: Notes + Questions) ‚ïê‚ïê‚ïê -->
<div class="page" id="page-search">
  <div class="home-wrap" style="max-width:800px">
    <div class="section-title">üîç Search Everything</div>
    <div class="search-bar"><input class="search-input" id="searchInput" placeholder="Search notes & questions‚Ä¶" oninput="doSearch()"/></div>
    <div id="searchResults"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê -->
<div class="page" id="page-history">
  <div class="history-wrap"><div class="history-card">
    <div class="history-header">
      <div class="history-title">üìä Test History</div>
      <div class="history-filters">
        <select id="historySubjectFilter" onchange="renderHistory()"><option value="">All</option><option>Mathematics</option><option>Science</option><option>English</option><option>GK</option><option>Intelligence</option><option>Social Studies</option></select>
      </div>
    </div>
    <div class="history-body" id="historyBody"></div>
  </div></div>
</div>

<!-- ‚ïê‚ïê‚ïê BOOKMARKS ‚ïê‚ïê‚ïê -->
<div class="page" id="page-bookmarks">
  <div class="bookmarks-wrap">
    <div class="section-title" style="font-size:1.4rem;margin-bottom:1.2rem">üîñ Bookmarked Questions</div>
    <div id="bookmarksBody"><div class="lb-empty">No bookmarks yet.</div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LEADERBOARD ‚ïê‚ïê‚ïê -->
<div class="page" id="page-leaderboard">
  <div class="lb-wrap"><div class="lb-card">
    <div class="lb-header">
      <div class="lb-title">üèÖ Leaderboard</div>
      <div class="lb-filter" id="lbFilter">
        <button class="lb-filter-btn active" onclick="lbFilter('All')">All</button>
        <button class="lb-filter-btn" onclick="lbFilter('Mathematics')">Math</button>
        <button class="lb-filter-btn" onclick="lbFilter('Science')">Science</button>
        <button class="lb-filter-btn" onclick="lbFilter('English')">English</button>
        <button class="lb-filter-btn" onclick="lbFilter('GK')">GK</button>
      </div>
    </div>
    <div id="lbBody"><div class="lb-empty">Loading‚Ä¶</div></div>
  </div></div>
</div>

<!-- ‚ïê‚ïê‚ïê ADMIN (Questions + Notes combined) ‚ïê‚ïê‚ïê -->
<div class="page" id="page-admin">
  <div class="admin-wrap">
    <div class="section-title">üõ°Ô∏è Admin Panel</div>
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="adminTab('addq')">‚ûï Q</button>
      <button class="admin-tab" onclick="adminTab('import')">üì• Import</button>
      <button class="admin-tab" onclick="adminTab('listq')">üìã Q List</button>
      <button class="admin-tab" onclick="adminTab('addn')">‚úèÔ∏è Note</button>
      <button class="admin-tab" onclick="adminTab('listn')">üìë Notes</button>
      <button class="admin-tab" onclick="adminTab('users')">üë§ Users</button>
    </div>

    <!-- ADD QUESTION -->
    <div class="admin-panel active" id="apAddq">
      <div class="admin-form">
        <h3>‚ûï Add Question</h3>
        <div class="form-row">
          <div><label class="form-label">Subject</label><select class="form-input" id="aSubject"><option>Mathematics</option><option>Science</option><option>English</option><option>GK</option><option>Intelligence</option><option>Social Studies</option></select></div>
          <div><label class="form-label">Difficulty</label><select class="form-input" id="aDiff"><option>Easy</option><option>Medium</option><option>Hard</option></select></div>
        </div>
        <div class="form-row">
          <div><label class="form-label">Chapter</label><input class="form-input" id="aChapter" placeholder="e.g. Algebra"/></div>
          <div><label class="form-label">Topic</label><input class="form-input" id="aTopic" placeholder="e.g. Linear Equations"/></div>
        </div>
        <div class="form-row one"><label class="form-label">Question</label><textarea class="form-input" id="aQuestion" rows="2" placeholder="Type question here‚Ä¶"></textarea></div>
        <div class="form-row">
          <div><label class="form-label">Option A</label><input class="form-input" id="opt0"/></div>
          <div><label class="form-label">Option B</label><input class="form-input" id="opt1"/></div>
        </div>
        <div class="form-row">
          <div><label class="form-label">Option C</label><input class="form-input" id="opt2"/></div>
          <div><label class="form-label">Option D</label><input class="form-input" id="opt3"/></div>
        </div>
        <div class="form-group"><label class="form-label">Correct Answer</label>
          <div class="radio-group"><label><input type="radio" name="correctOpt" value="0" checked/> A</label><label><input type="radio" name="correctOpt" value="1"/> B</label><label><input type="radio" name="correctOpt" value="2"/> C</label><label><input type="radio" name="correctOpt" value="3"/> D</label></div>
        </div>
        <div class="form-row one"><label class="form-label">Explanation (optional)</label><textarea class="form-input" id="aExplanation" rows="2" placeholder="Why is this the correct answer?"></textarea></div>
        <button class="btn-sm" id="saveQBtn" onclick="saveQuestion()">üíæ Save Question</button>
      </div>
    </div>

    <!-- IMPORT QUESTIONS -->
    <div class="admin-panel" id="apImport">
      <div class="admin-form">
        <h3>üì• Import Questions (CSV / Google Sheets)</h3>
        <div style="display:flex;gap:.4rem;margin-bottom:1rem">
          <button class="btn-sm" id="importTabFile" onclick="switchImportTab('file')" style="background:var(--olive)">üìÅ CSV File</button>
          <button class="btn-sm" id="importTabUrl" onclick="switchImportTab('url')" style="background:var(--sand);color:var(--text)">üîó Google Sheets URL</button>
        </div>

        <!-- FILE UPLOAD -->
        <div id="importFileSection">
          <div style="background:var(--sand);border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;border-left:4px solid var(--olive-light);font-size:.85rem;line-height:1.7">
            <strong>CSV Column Headers (Row 1):</strong><br>
            <code style="background:var(--white);padding:2px 6px;border-radius:4px;font-size:.8rem">subject | chapter | topic | difficulty | question | optionA | optionB | optionC | optionD | correct | explanation</code><br>
            <b>correct</b> = A, B, C, or D
          </div>
          <div class="form-row one">
            <label class="form-label">Select CSV File</label>
            <input type="file" class="form-input" id="csvFileInput" accept=".csv" onchange="previewFile()" style="padding:8px"/>
          </div>
        </div>

        <!-- URL INPUT -->
        <div id="importUrlSection" style="display:none">
          <div style="background:var(--sand);border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;border-left:4px solid var(--olive-light);font-size:.85rem;line-height:1.7">
            <b>1.</b> Google Sheet with headers above ‚Üí <b>2.</b> File ‚Üí Share ‚Üí Publish to web ‚Üí CSV ‚Üí <b>3.</b> Paste URL below<br>
            <b style="color:var(--red)">‚ö†Ô∏è If URL doesn't work, use CSV File Upload</b>
          </div>
          <div class="form-row one">
            <label class="form-label">Published CSV URL</label>
            <input class="form-input" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/.../pub?output=csv"/>
          </div>
          <button class="btn-sm" id="previewBtn" onclick="previewSheet()" style="margin-top:.5rem">üëÅ Preview from URL</button>
        </div>

        <!-- PREVIEW TABLE -->
        <div id="importPreviewWrap" style="display:none;margin-top:1rem">
          <div style="display:flex;gap:.8rem;align-items:center;margin-bottom:.5rem;flex-wrap:wrap">
            <span style="font-weight:700;font-size:.9rem">üìã Preview: <span id="previewCount">0</span> rows</span>
            <span id="dupWarning" style="display:none;color:#856404;font-size:.82rem;font-weight:700"></span>
            <span id="errorCount" style="display:none;color:var(--red);font-size:.82rem;font-weight:700"></span>
          </div>
          <div style="overflow-x:auto;max-height:350px;overflow-y:auto;border:2px solid var(--sand);border-radius:10px">
            <table class="q-list-table" style="margin:0">
              <thead style="position:sticky;top:0;background:var(--white);z-index:1"><tr><th>#</th><th>Subject</th><th>Chapter/Topic</th><th>Question</th><th>Ans</th><th>Status</th></tr></thead>
              <tbody id="importPreviewBody"></tbody>
            </table>
          </div>
        </div>

        <!-- PROGRESS BAR -->
        <div id="importProgressWrap" style="display:none;margin-top:1rem">
          <div style="display:flex;justify-content:space-between;font-size:.82rem;font-weight:700;margin-bottom:4px">
            <span id="importProgressLabel">Uploading‚Ä¶</span><span id="importProgressPct">0%</span>
          </div>
          <div style="height:8px;background:var(--sand);border-radius:4px;overflow:hidden">
            <div id="importProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--olive-light),var(--khaki));border-radius:4px;transition:width .3s"></div>
          </div>
          <div id="importResultSummary" style="display:none;margin-top:.5rem;font-size:.88rem"></div>
        </div>

        <div style="display:flex;gap:.5rem;margin-top:1rem">
          <button class="btn-sm" id="importBtn" style="display:none" onclick="importToFirebase()">‚¨Ü Upload to Firebase</button>
          <button class="btn-sec" id="clearImportBtn" style="display:none" onclick="clearImport()">‚úï Clear</button>
        </div>
      </div>
    </div>

    <!-- LIST QUESTIONS -->
    <div class="admin-panel" id="apListq">
      <div class="admin-form" style="padding:1rem">
        <h3>üìã All Questions (<span id="qCount">0</span>)</h3>
        <div class="form-row">
          <select class="form-input" id="filterSubj" onchange="renderQList()"><option value="">All Subjects</option><option>Mathematics</option><option>Science</option><option>English</option><option>GK</option><option>Intelligence</option><option>Social Studies</option></select>
          <select class="form-input" id="filterDiff" onchange="renderQList()"><option value="">All Difficulties</option><option>Easy</option><option>Medium</option><option>Hard</option></select>
        </div>
        <div style="overflow-x:auto"><table class="q-list-table">
          <thead><tr><th>#</th><th>Subject</th><th>Chapter/Topic</th><th>Question</th><th>Diff</th><th>Act</th></tr></thead>
          <tbody id="qListBody"></tbody>
        </table></div>
      </div>
    </div>

    <!-- ADD NOTE -->
    <div class="admin-panel" id="apAddn">
      <div class="admin-form">
        <h3>‚úèÔ∏è Create / Edit Note</h3>
        <div class="form-row">
          <div><label class="form-label">Class</label><select class="form-input" id="nClass"><option>Class 6</option><option>Class 9</option></select></div>
          <div><label class="form-label">Subject</label><select class="form-input" id="nSubject"><option>Mathematics</option><option>Science</option><option>English</option><option>GK</option><option>Intelligence</option><option>Social Studies</option></select></div>
        </div>
        <div class="form-row">
          <div><label class="form-label">Chapter</label><input class="form-input" id="nChapter" placeholder="e.g. Algebra"/></div>
          <div><label class="form-label">Topic</label><input class="form-input" id="nTopic" placeholder="e.g. Linear Equations"/></div>
        </div>
        <div class="form-row one"><label class="form-label">Note Title</label><input class="form-input" id="nTitle" placeholder="e.g. Understanding Linear Equations"/></div>
        <div class="form-row one"><label class="form-label">Order</label><input class="form-input" id="nOrder" type="number" value="1" min="1" style="max-width:100px"/></div>
        <div class="editor-wrap">
          <div class="editor-pane">
            <div class="editor-pane-label">‚úèÔ∏è Markdown
              <div class="tb">
                <button class="tb-btn" onclick="insMd('**','**')"><b>B</b></button>
                <button class="tb-btn" onclick="insMd('*','*')"><i>I</i></button>
                <button class="tb-btn" onclick="insMd('# ','')">H1</button>
                <button class="tb-btn" onclick="insMd('## ','')">H2</button>
                <button class="tb-btn" onclick="insMd('- ','')">‚Ä¢</button>
                <button class="tb-btn" onclick="insMd('> ','')">‚ùù</button>
                <button class="tb-btn" onclick="insMd('$$\n','\n$$')">‚àë</button>
                <button class="tb-btn" onclick="insMd('$','$')">ùë•</button>
                <button class="tb-btn" onclick="insMd('| A | B |\n|---|---|\n| 1 | 2 |','')">‚äû</button>
                <button class="tb-btn" onclick="insMd(':::tip\n','\n:::')">üí°</button>
                <button class="tb-btn" onclick="insMd(':::important\n','\n:::')">‚ùó</button>
                <button class="tb-btn" onclick="insMd(':::warning\n','\n:::')">‚ö†</button>
              </div>
            </div>
            <textarea class="md-editor" id="nContent" placeholder="Write markdown‚Ä¶&#10;&#10;# Heading&#10;**Bold** *italic*&#10;$x^2 + y^2 = z^2$&#10;&#10;:::tip&#10;Helpful info&#10;:::" oninput="updatePreview()"></textarea>
          </div>
          <div class="editor-pane">
            <div class="editor-pane-label">üëÅ Preview</div>
            <div class="preview-pane note-content" id="editorPreview"><div class="empty-state"><div class="empty-icon">‚úèÔ∏è</div>Start typing‚Ä¶</div></div>
          </div>
        </div>
        <div style="display:flex;gap:.8rem;margin-top:1rem;align-items:center">
          <button class="btn-sm" onclick="saveNote()" id="saveNoteBtn">üíæ Save Note</button>
          <button class="btn-sec" onclick="clearNoteEditor()">Clear</button>
          <input type="hidden" id="editingNoteId" value=""/>
          <span id="editingLabel" style="font-size:.8rem;color:var(--blue);font-weight:700;display:none">‚úèÔ∏è Editing</span>
        </div>
      </div>
    </div>

    <!-- LIST NOTES -->
    <div class="admin-panel" id="apListn">
      <div class="admin-form" style="padding:1rem">
        <h3>üìë All Notes (<span id="noteCount">0</span>)</h3>
        <div class="form-row">
          <select class="form-input" id="filterNoteClass" onchange="renderNotesList()"><option value="">All Classes</option><option>Class 6</option><option>Class 9</option></select>
          <select class="form-input" id="filterNoteSubj" onchange="renderNotesList()"><option value="">All Subjects</option><option>Mathematics</option><option>Science</option><option>English</option><option>GK</option><option>Intelligence</option><option>Social Studies</option></select>
        </div>
        <div style="overflow-x:auto"><table class="notes-list-table">
          <thead><tr><th>#</th><th>Class</th><th>Subject</th><th>Chapter/Topic</th><th>Title</th><th>Act</th></tr></thead>
          <tbody id="notesListBody"></tbody>
        </table></div>
      </div>
    </div>

    <!-- USERS -->
    <div class="admin-panel" id="apUsers">
      <div class="admin-form" style="padding:1rem">
        <h3>üë§ Users</h3>
        <table class="q-list-table"><thead><tr><th>Name</th><th>Email</th><th>Tests</th><th>Avg</th><th>Best</th></tr></thead><tbody id="usersBody"></tbody></table>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  APP LOGIC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
function waitFB(fn){if(window._FB)fn();else setTimeout(()=>waitFB(fn),50)}

const SUBJECTS=[{name:'Mathematics',icon:'üìê'},{name:'Science',icon:'üî¨'},{name:'English',icon:'üìñ'},{name:'GK',icon:'üåè'},{name:'Intelligence',icon:'üß†'},{name:'Social Studies',icon:'üìö'}];
const CLASSES=['Class 6','Class 9'];

let allQuestions=[],allNotes=[],notesCacheTime=0;
const CACHE_TTL=5*60*1000;
let currentQuiz={questions:[],index:0,correct:0,wrong:0,timedOut:0,selectedSubject:'',chapter:'',topic:''};
let timerInterval=null,lbCurrentFilter='All',bookmarkedQuestions=[];
let browseState={cls:'Class 6',subject:null,chapter:null};

function hideLoader(){document.getElementById('loader').classList.add('hidden')}
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}

function normalizeSubject(s){if(!s)return'GK';const m={'general knowledge':'GK','general_knowledge':'GK','gk':'GK','math':'Mathematics','maths':'Mathematics','mathematics':'Mathematics','science':'Science','english':'English','intelligence':'Intelligence','social studies':'Social Studies','social_studies':'Social Studies'};return m[s.toLowerCase()]||s}

/* ‚ïê‚ïê PAGE ROUTER ‚ïê‚ïê */
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('readingProgress').style.width='0%';
  window.onscroll=null;
  if(name==='home') initHome();
  if(name==='history') renderHistory();
  if(name==='bookmarks') renderBookmarks();
  if(name==='leaderboard') renderLeaderboard();
  if(name==='admin'){adminTab('addq');renderQList();renderNotesList();renderUsers()}
  if(name==='search') document.getElementById('searchInput').focus();
}
function switchAuth(to){document.querySelectorAll('#page-login,#page-register').forEach(p=>p.classList.remove('active'));document.getElementById('page-'+to).classList.add('active')}

/* ‚ïê‚ïê MODE TOGGLE ‚ïê‚ïê */
function setMode(mode,btn){
  document.querySelectorAll('.mode-tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.mode-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('mode-'+mode).classList.add('active');
  if(mode==='notes') initNotesBrowse();
}

/* ‚ïê‚ïê AUTH ‚ïê‚ïê */
async function doLogin(){
  const e=document.getElementById('loginEmail').value.trim(),p=document.getElementById('loginPass').value,err=document.getElementById('loginErr'),btn=document.getElementById('loginBtn');
  err.classList.remove('show');btn.disabled=true;btn.textContent='Logging in‚Ä¶';
  try{await window._FB.signInWithEmailAndPassword(window._FB.auth,e,p)}catch(ex){err.textContent=friendlyErr(ex.code);err.classList.add('show');btn.disabled=false;btn.textContent='Login ‚Üí'}
}
async function doRegister(){
  const n=document.getElementById('regName').value.trim(),e=document.getElementById('regEmail').value.trim(),p=document.getElementById('regPass').value,err=document.getElementById('regErr'),btn=document.getElementById('regBtn');
  if(!n){err.textContent='Enter your name';err.classList.add('show');return}
  err.classList.remove('show');btn.disabled=true;btn.textContent='Creating‚Ä¶';
  try{const c=await window._FB.createUserWithEmailAndPassword(window._FB.auth,e,p);await window._FB.setDoc(window._FB.doc(window._FB.db,'users',c.user.uid),{name:n,email:e,isAdmin:false,scores:[],createdAt:Date.now()})}
  catch(ex){err.textContent=friendlyErr(ex.code);err.classList.add('show');btn.disabled=false;btn.textContent='Create Account ‚Üí'}
}
function friendlyErr(c){const m={'auth/invalid-email':'Invalid email.','auth/user-not-found':'No account found.','auth/wrong-password':'Wrong password.','auth/email-already-in-use':'Email already registered.','auth/weak-password':'Password must be 6+ characters.','auth/invalid-credential':'Invalid email or password.','auth/too-many-requests':'Too many attempts.'};return m[c]||'Something went wrong.'}

/* ‚ïê‚ïê DATA LOADING ‚ïê‚ïê */
async function loadQuestions(){const s=await window._FB.getDocs(window._FB.collection(window._FB.db,'questions'));allQuestions=s.docs.map(d=>{const x=d.data();return{id:d.id,...x,subject:normalizeSubject(x.subject)}})}
async function loadNotes(force){if(!force&&allNotes.length&&(Date.now()-notesCacheTime<CACHE_TTL))return;const s=await window._FB.getDocs(window._FB.collection(window._FB.db,'notes'));allNotes=s.docs.map(d=>({id:d.id,...d.data()}));notesCacheTime=Date.now()}

/* ‚ïê‚ïê HOME ‚ïê‚ïê */
async function initHome(){
  if(!window.currentUser)return;
  document.getElementById('welcomeName').textContent=`Welcome, ${window.currentUser.name}! üéñÔ∏è`;
  const sc=window.currentUser.scores||[];
  document.getElementById('statTests').textContent=sc.length||0;
  if(sc.length){const a=Math.round(sc.reduce((s,x)=>s+x.pct,0)/sc.length),b=Math.max(...sc.map(s=>s.pct));document.getElementById('statAvg').textContent=a+'%';document.getElementById('statBest').textContent=b+'%'}
  else{document.getElementById('statAvg').textContent='‚Äì';document.getElementById('statBest').textContent='‚Äì'}
  if(!allQuestions.length)await loadQuestions();
  renderSubjectGrid();
  currentQuiz.selectedSubject='';
  document.getElementById('chapterSel').innerHTML='<option value="">‚Äî Chapter ‚Äî</option>';
  document.getElementById('topicSel').innerHTML='<option value="">‚Äî All Topics ‚Äî</option>';
  document.getElementById('startBtn').disabled=true;
}

function renderSubjectGrid(){
  document.getElementById('subjectGrid').innerHTML=SUBJECTS.map(s=>{
    const cnt=allQuestions.filter(q=>q.subject===s.name).length;
    return `<div class="subject-card" onclick="selectSubject('${s.name}',this)"><div class="subject-icon">${s.icon}</div><div class="subject-name">${s.name}</div><div class="subject-count">${cnt} questions</div></div>`;
  }).join('');
}

function selectSubject(name,el){
  document.querySelectorAll('.subject-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  currentQuiz.selectedSubject=name;
  const chs=[...new Set(allQuestions.filter(q=>q.subject===name).map(q=>q.chapter))];
  document.getElementById('chapterSel').innerHTML='<option value="">‚Äî All Chapters ‚Äî</option>'+chs.map(c=>`<option>${c}</option>`).join('');
  document.getElementById('topicSel').innerHTML='<option value="">‚Äî All Topics ‚Äî</option>';
  document.getElementById('startBtn').disabled=false;
}
function updateTopics(){
  const ch=document.getElementById('chapterSel').value;
  const ts=ch?[...new Set(allQuestions.filter(q=>q.subject===currentQuiz.selectedSubject&&q.chapter===ch).map(q=>q.topic))]:[];
  document.getElementById('topicSel').innerHTML='<option value="">‚Äî All Topics ‚Äî</option>'+ts.map(t=>`<option>${t}</option>`).join('');
}

/* ‚ïê‚ïê QUIZ ENGINE ‚ïê‚ïê */
function startQuiz(){
  if(!currentQuiz.selectedSubject){showToast('Select a subject!');return}
  const ch=document.getElementById('chapterSel').value,tp=document.getElementById('topicSel').value,cnt=parseInt(document.getElementById('countSel').value);
  let pool=allQuestions.filter(q=>q.subject===currentQuiz.selectedSubject);
  if(ch)pool=pool.filter(q=>q.chapter===ch);if(tp)pool=pool.filter(q=>q.topic===tp);
  if(!pool.length){showToast('No questions found!');return}
  pool=pool.sort(()=>Math.random()-.5).slice(0,cnt);
  currentQuiz.questions=pool;currentQuiz.index=0;currentQuiz.correct=0;currentQuiz.wrong=0;currentQuiz.timedOut=0;currentQuiz.chapter=ch;currentQuiz.topic=tp;
  showPage('quiz');renderQuestion();
}

function renderQuestion(){
  clearInterval(timerInterval);
  const q=currentQuiz.questions[currentQuiz.index],tot=currentQuiz.questions.length,i=currentQuiz.index;
  document.getElementById('quizBreadcrumb').textContent=`${currentQuiz.selectedSubject} ‚Ä∫ ${q.chapter} ‚Ä∫ ${q.topic}`;
  document.getElementById('quizProgressText').textContent=`${i+1}/${tot}`;
  document.getElementById('qNum').textContent=`Question ${i+1} of ${tot}`;
  document.getElementById('qText').innerHTML=`${q.question}<button class="bookmark-btn ${bookmarkedQuestions.some(b=>b.id===q.id)?'bookmarked':''}" id="bookmarkBtn" onclick="toggleBookmark('${q.id}')">${bookmarkedQuestions.some(b=>b.id===q.id)?'üîñ':'üè∑Ô∏è'}</button>`;
  document.getElementById('progressFill').style.width=`${(i/tot)*100}%`;
  const keys=['A','B','C','D'];
  document.getElementById('optionsList').innerHTML=q.options.map((o,j)=>`<button class="option-btn" onclick="pickOption(${j})" id="qopt${j}"><span class="option-key">${keys[j]}</span>${o}</button>`).join('');
  document.getElementById('explanationBox').classList.remove('show');
  document.getElementById('nextBtn').classList.remove('show');
  let time=30;const td=document.getElementById('timerDisplay');td.textContent=time;td.classList.remove('danger');
  timerInterval=setInterval(()=>{time--;td.textContent=time;if(time<=5)td.classList.add('danger');if(time<=0){clearInterval(timerInterval);currentQuiz.timedOut++;autoReveal()}},1000);
}

function pickOption(idx){
  clearInterval(timerInterval);
  const q=currentQuiz.questions[currentQuiz.index],correct=parseInt(q.correct);
  document.querySelectorAll('.option-btn').forEach(b=>b.classList.add('disabled'));
  document.getElementById('qopt'+correct).classList.add('correct');
  if(idx===correct)currentQuiz.correct++;else{currentQuiz.wrong++;document.getElementById('qopt'+idx).classList.add('wrong')}
  if(q.explanation){document.getElementById('explanationText').textContent=q.explanation;document.getElementById('explanationBox').classList.add('show')}
  document.getElementById('nextBtn').classList.add('show');
}
function autoReveal(){
  const q=currentQuiz.questions[currentQuiz.index],correct=parseInt(q.correct);
  document.querySelectorAll('.option-btn').forEach(b=>b.classList.add('disabled'));
  document.getElementById('qopt'+correct).classList.add('correct');
  if(q.explanation){document.getElementById('explanationText').textContent=q.explanation;document.getElementById('explanationBox').classList.add('show')}
  document.getElementById('nextBtn').classList.add('show');
}

async function nextQuestion(){
  currentQuiz.index++;
  if(currentQuiz.index<currentQuiz.questions.length){renderQuestion();return}
  // DONE
  const tot=currentQuiz.questions.length,pct=Math.round((currentQuiz.correct/tot)*100);
  document.getElementById('resultPct').textContent=pct+'%';
  document.getElementById('rCorrect').textContent=currentQuiz.correct;
  document.getElementById('rWrong').textContent=currentQuiz.wrong;
  document.getElementById('rTimeout').textContent=currentQuiz.timedOut;
  const ring=document.getElementById('resultRing');
  ring.className='result-score-ring '+(pct>=90?'excellent':pct>=75?'good':pct>=50?'avg':'poor');
  document.getElementById('resultTitle').textContent=pct>=90?'Excellent! üåü':pct>=75?'Great job! üéñÔ∏è':pct>=50?'Good effort! üí™':'Keep practicing! üìö';
  showPage('result');

  const score={subject:currentQuiz.selectedSubject,chapter:currentQuiz.chapter||'',topic:currentQuiz.topic||'',total:tot,correct:currentQuiz.correct,pct,ts:Date.now()};
  try{
    await window._FB.updateDoc(window._FB.doc(window._FB.db,'users',window.currentUser.uid),{scores:window._FB.arrayUnion(score)});
    window.currentUser.scores=window.currentUser.scores||[];window.currentUser.scores.push(score);
  }catch(e){}
}

/* ‚ïê‚ïê BOOKMARKS ‚ïê‚ïê */
function loadBookmarks(){if(window.currentUser){try{bookmarkedQuestions=JSON.parse(localStorage.getItem('bm_'+window.currentUser.uid)||'[]')}catch(e){bookmarkedQuestions=[]}}}
function saveBookmarks(){if(window.currentUser)localStorage.setItem('bm_'+window.currentUser.uid,JSON.stringify(bookmarkedQuestions))}
function toggleBookmark(id){
  const idx=bookmarkedQuestions.findIndex(b=>b.id===id);
  if(idx>=0){bookmarkedQuestions.splice(idx,1);showToast('Bookmark removed')}
  else{const q=currentQuiz.questions[currentQuiz.index];bookmarkedQuestions.push({id:q.id,question:q.question,options:q.options,correct:q.correct,explanation:q.explanation,subject:q.subject,chapter:q.chapter,topic:q.topic});showToast('Bookmarked!')}
  saveBookmarks();
  const btn=document.getElementById('bookmarkBtn');
  if(btn){const bk=bookmarkedQuestions.some(b=>b.id===id);btn.classList.toggle('bookmarked',bk);btn.textContent=bk?'üîñ':'üè∑Ô∏è'}
}
function renderBookmarks(){
  loadBookmarks();const el=document.getElementById('bookmarksBody');
  if(!bookmarkedQuestions.length){el.innerHTML='<div class="lb-empty">No bookmarks yet. Bookmark questions during tests!</div>';return}
  const keys=['A','B','C','D'];
  el.innerHTML=bookmarkedQuestions.map(b=>`<div class="bookmark-card">
    <span class="bm-remove" onclick="removeBm('${b.id}')">‚úï Remove</span>
    <div class="bm-question">${b.question}</div>
    <div class="bm-options">${b.options.map((o,i)=>`<div class="bm-opt ${i===parseInt(b.correct)?'correct':''}">${keys[i]}. ${o}</div>`).join('')}</div>
    <div class="bm-meta">${b.subject} ‚Ä∫ ${b.chapter} ‚Ä∫ ${b.topic}</div>
    ${b.explanation?`<div style="margin-top:.4rem;font-size:.82rem;color:var(--olive)">üí° ${b.explanation}</div>`:''}
  </div>`).join('');
}
function removeBm(id){bookmarkedQuestions=bookmarkedQuestions.filter(b=>b.id!==id);saveBookmarks();renderBookmarks();showToast('Removed')}

/* ‚ïê‚ïê HISTORY ‚ïê‚ïê */
function renderHistory(){
  const sc=window.currentUser?.scores||[];const f=document.getElementById('historySubjectFilter').value;
  const filtered=f?sc.filter(s=>s.subject===f):sc;
  const el=document.getElementById('historyBody');
  if(!filtered.length){el.innerHTML='<div class="lb-empty">No tests yet.</div>';return}
  el.innerHTML=[...filtered].reverse().map(s=>{
    const d=new Date(s.ts),cls=s.pct>=90?'excellent':s.pct>=75?'good':s.pct>=50?'average':'poor';
    return `<div class="history-row"><div class="history-date"><div class="history-date-day">${d.getDate()}</div><div class="history-date-month">${d.toLocaleString('default',{month:'short'})}</div></div><div class="history-info"><div class="history-test-name">${s.subject} ${s.chapter?'- '+s.chapter:''}</div><div class="history-test-details">${s.total}Q ¬∑ ${s.topic||'Practice'}</div></div><div><div class="history-score-val ${cls}">${s.pct}%</div><div class="history-score-sub">${s.correct}/${s.total}</div></div></div>`;
  }).join('');
}

/* ‚ïê‚ïê LEADERBOARD ‚ïê‚ïê */
async function renderLeaderboard(){
  const snap=await window._FB.getDocs(window._FB.collection(window._FB.db,'users'));
  const users=snap.docs.map(d=>({id:d.id,...d.data()})).filter(u=>(u.scores||[]).length);
  const f=lbCurrentFilter;
  const ranked=users.map(u=>{
    let sc=u.scores||[];if(f!=='All')sc=sc.filter(s=>s.subject===f);
    if(!sc.length)return null;
    const avg=Math.round(sc.reduce((a,b)=>a+b.pct,0)/sc.length);
    return{name:u.name,avg,tests:sc.length};
  }).filter(Boolean).sort((a,b)=>b.avg-a.avg);
  document.getElementById('lbBody').innerHTML=ranked.length?ranked.map((u,i)=>{
    const medal=i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'';
    return `<div class="lb-row"><div class="lb-rank">${medal||i+1}</div><div class="lb-name">${u.name}</div><div class="lb-score">${u.avg}% <span style="font-size:.7rem;color:var(--text-muted)">(${u.tests})</span></div></div>`;
  }).join(''):'<div class="lb-empty">No scores yet.</div>';
}
function lbFilter(f){lbCurrentFilter=f;document.querySelectorAll('.lb-filter-btn').forEach(b=>b.classList.toggle('active',b.textContent.includes(f==='All'?'All':f.substring(0,4))));renderLeaderboard()}

/* ‚ïê‚ïê NOTES BROWSE ‚ïê‚ïê */
async function initNotesBrowse(){
  await loadNotes();
  renderClassSelector();
  renderBrowse();
}
function renderClassSelector(){
  document.getElementById('classSelector').innerHTML=CLASSES.map(c=>`<button class="class-btn ${browseState.cls===c?'active':''}" onclick="selectBrowseClass('${c}',this)">${c}</button>`).join('');
}
function selectBrowseClass(c,btn){browseState={cls:c,subject:null,chapter:null};document.querySelectorAll('.class-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderBrowse()}

function renderBrowse(){
  const el=document.getElementById('browseContent'),notes=allNotes.filter(n=>n.class===browseState.cls);
  if(!browseState.subject){
    const counts={};notes.forEach(n=>{counts[n.subject]=(counts[n.subject]||0)+1});
    el.innerHTML=`<div class="section-title">üìö Select Subject</div><div class="subject-grid">${SUBJECTS.map(s=>{const c=counts[s.name]||0;return `<div class="subject-card" onclick="browseSubject('${s.name}')"><div class="subject-icon">${s.icon}</div><div class="subject-name">${s.name}</div><div class="subject-count">${c} note${c!==1?'s':''}</div></div>`}).join('')}</div>${!notes.length?'<div class="empty-state"><div class="empty-icon">üìù</div>No notes yet</div>':''}`;
    return;
  }
  const sn=notes.filter(n=>n.subject===browseState.subject);
  if(!browseState.chapter){
    const chs={};sn.forEach(n=>{if(!chs[n.chapter])chs[n.chapter]={count:0,topics:new Set()};chs[n.chapter].count++;if(n.topic)chs[n.chapter].topics.add(n.topic)});
    const sub=SUBJECTS.find(s=>s.name===browseState.subject);
    el.innerHTML=`${bc([{l:browseState.cls,a:`browseState={cls:'${browseState.cls}',subject:null,chapter:null};renderBrowse()`},{l:browseState.subject}])}
      <div class="section-title">${sub?sub.icon:''} ${browseState.subject} ‚Äî Chapters</div>
      <div class="chapter-list">${Object.entries(chs).sort((a,b)=>a[0].localeCompare(b[0])).map(([ch,info])=>`<div class="chapter-card" onclick="browseChapter('${esc(ch)}')"><div><div class="chapter-name">${ch}</div><div class="chapter-meta">${info.topics.size} topic${info.topics.size!==1?'s':''}</div></div><div class="chapter-count">${info.count}</div></div>`).join('')}</div>
      ${!Object.keys(chs).length?'<div class="empty-state"><div class="empty-icon">üìù</div>No notes</div>':''}`;
    return;
  }
  const cn=sn.filter(n=>n.chapter===browseState.chapter).sort((a,b)=>(a.order||99)-(b.order||99));
  const topics={};cn.forEach(n=>{const t=n.topic||'General';if(!topics[t])topics[t]=[];topics[t].push(n)});
  el.innerHTML=`${bc([{l:browseState.cls,a:`browseState={cls:'${browseState.cls}',subject:null,chapter:null};renderBrowse()`},{l:browseState.subject,a:`browseState.chapter=null;renderBrowse()`},{l:browseState.chapter}])}
    <div class="section-title">üìë ${browseState.chapter}</div>
    ${Object.entries(topics).map(([t,ns])=>`<div style="margin-bottom:1.2rem"><div style="font-family:'Rajdhani',sans-serif;font-size:1rem;font-weight:700;color:var(--olive);margin-bottom:.5rem">üìå ${t}</div>
      <div class="topic-list">${ns.map(n=>`<div class="topic-card" onclick="openNote('${n.id}')"><div class="topic-name">${n.title||t}</div><div class="topic-updated">${timeAgo(n.updatedAt||n.createdAt)}</div></div>`).join('')}</div></div>`).join('')}`;
}
function browseSubject(s){browseState.subject=s;browseState.chapter=null;renderBrowse()}
function browseChapter(c){browseState.chapter=c;renderBrowse()}
function bc(items){return `<div class="breadcrumbs">${items.map((it,i)=>i<items.length-1?`<span class="bc-item" onclick="${it.a}">${it.l}</span><span class="bc-sep">‚Ä∫</span>`:`<span class="bc-cur">${it.l}</span>`).join('')}</div>`}

/* ‚ïê‚ïê NOTE READER ‚ïê‚ïê */
function openNote(id){
  const n=allNotes.find(x=>x.id===id);if(!n){showToast('Not found');return}
  const html=renderMd(n.content||'');
  document.getElementById('noteReader').innerHTML=`
    <div class="breadcrumbs">
      <span class="bc-item" onclick="showPage('home')">Home</span><span class="bc-sep">‚Ä∫</span>
      <span class="bc-item" onclick="browseState={cls:'${n.class}',subject:null,chapter:null};setMode('notes',document.querySelectorAll('.mode-tab')[1]);showPage('home')">${n.class}</span><span class="bc-sep">‚Ä∫</span>
      <span class="bc-item" onclick="browseState={cls:'${n.class}',subject:'${n.subject}',chapter:null};setMode('notes',document.querySelectorAll('.mode-tab')[1]);showPage('home')">${n.subject}</span><span class="bc-sep">‚Ä∫</span>
      <span class="bc-item" onclick="browseState={cls:'${n.class}',subject:'${n.subject}',chapter:'${esc(n.chapter)}'};setMode('notes',document.querySelectorAll('.mode-tab')[1]);showPage('home')">${n.chapter}</span><span class="bc-sep">‚Ä∫</span>
      <span class="bc-cur">${n.topic}</span>
    </div>
    <div class="note-card">
      <div class="note-title">${n.title}</div>
      <div class="note-meta-bar">
        <div class="note-meta-item">üìö ${n.class}</div><div class="note-meta-item">üìñ ${n.subject}</div>
        <div class="note-meta-item">üìë ${n.chapter}</div><div class="note-meta-item">üìå ${n.topic}</div>
        <div class="note-meta-item">üïê ${timeAgo(n.updatedAt||n.createdAt)}</div>
      </div>
      <div class="note-content" id="noteContentArea">${html}</div>
    </div>
    <div style="display:flex;gap:.8rem;justify-content:center;margin-top:1rem;flex-wrap:wrap">
      <button class="btn-sec" onclick="showPage('home')" style="padding:9px 22px">‚Üê Back</button>
      ${window.currentUser?.isAdmin?`<button class="btn-sm" onclick="editNote('${id}')" style="padding:9px 22px">‚úèÔ∏è Edit</button>`:''}
    </div>`;
  showPage('reader');
  setTimeout(()=>{const a=document.getElementById('noteContentArea');if(a)renderMathInElement(a,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}],throwOnError:false})},50);
  window.onscroll=()=>{const h=document.documentElement;document.getElementById('readingProgress').style.width=Math.min((h.scrollTop/(h.scrollHeight-h.clientHeight))*100,100)+'%'};
}

/* ‚ïê‚ïê MARKDOWN ‚ïê‚ïê */
function renderMd(md){
  md=md.replace(/:::(tip|important|warning)\n([\s\S]*?):::/g,(m,t,c)=>{const ic={tip:'üí°',important:'‚ùó',warning:'‚ö†Ô∏è'};return `<div class="box-${t}"><strong>${ic[t]||''} ${t.charAt(0).toUpperCase()+t.slice(1)}</strong><br>${c.trim()}</div>`});
  marked.setOptions({breaks:true,gfm:true});return marked.parse(md);
}

/* ‚ïê‚ïê COMBINED SEARCH ‚ïê‚ïê */
async function doSearch(){
  await loadNotes();if(!allQuestions.length)await loadQuestions();
  const q=document.getElementById('searchInput').value.trim().toLowerCase(),el=document.getElementById('searchResults');
  if(!q){el.innerHTML='';return}
  const ws=q.split(/\s+/);
  const noteResults=allNotes.filter(n=>{const h=`${n.title} ${n.subject} ${n.chapter} ${n.topic} ${n.content} ${n.class}`.toLowerCase();return ws.every(w=>h.includes(w))}).slice(0,10).map(n=>({type:'note',title:n.title,path:`${n.class} ‚Ä∫ ${n.subject} ‚Ä∫ ${n.chapter} ‚Ä∫ ${n.topic}`,preview:(n.content||'').replace(/[#*`\[\]()>|_~-]/g,'').substring(0,100)+'‚Ä¶',id:n.id}));
  const qResults=allQuestions.filter(q2=>{const h=`${q2.question} ${q2.subject} ${q2.chapter} ${q2.topic}`.toLowerCase();return ws.every(w=>h.includes(w))}).slice(0,10).map(q2=>({type:'quiz',title:q2.question,path:`${q2.subject} ‚Ä∫ ${q2.chapter} ‚Ä∫ ${q2.topic}`,preview:q2.options.join(' | '),id:q2.id}));
  const all=[...noteResults,...qResults];
  if(!all.length){el.innerHTML=`<div class="empty-state"><div class="empty-icon">üîç</div>No results for "${q}"</div>`;return}
  el.innerHTML=all.map(r=>`<div class="search-result-card" onclick="${r.type==='note'?`openNote('${r.id}')`:`showToast('Use Practice Quiz to attempt this question')`}">
    <div class="sr-title">${r.title.substring(0,80)}${r.title.length>80?'‚Ä¶':''} <span class="sr-type ${r.type}">${r.type==='note'?'üìñ Note':'üìù Question'}</span></div>
    <div class="sr-path">${r.path}</div>
    <div class="sr-preview">${r.preview}</div>
  </div>`).join('');
}

/* ‚ïê‚ïê ADMIN ‚ïê‚ïê */
let importedRows=[];

function adminTab(tab){
  const tabs=['addq','import','listq','addn','listn','users'];
  document.querySelectorAll('.admin-tab').forEach((t,i)=>t.classList.toggle('active',tabs[i]===tab));
  document.querySelectorAll('.admin-panel').forEach(p=>p.classList.remove('active'));
  const panelId='ap'+tab.charAt(0).toUpperCase()+tab.slice(1);
  document.getElementById(panelId).classList.add('active');
  if(tab==='listq')renderQList();if(tab==='listn')renderNotesList();if(tab==='users')renderUsers();
}

/* ‚ïê‚ïê CSV / GOOGLE SHEETS IMPORT ‚ïê‚ïê */
function switchImportTab(tab){
  const f=document.getElementById('importTabFile'),u=document.getElementById('importTabUrl');
  if(tab==='file'){f.style.background='var(--olive)';f.style.color='var(--white)';u.style.background='var(--sand)';u.style.color='var(--text)';document.getElementById('importFileSection').style.display='';document.getElementById('importUrlSection').style.display='none'}
  else{u.style.background='var(--olive)';u.style.color='var(--white)';f.style.background='var(--sand)';f.style.color='var(--text)';document.getElementById('importFileSection').style.display='none';document.getElementById('importUrlSection').style.display=''}
  clearImport();
}

function previewFile(){
  const file=document.getElementById('csvFileInput').files[0];
  if(!file){showToast('Select a CSV file');return}
  const reader=new FileReader();
  reader.onload=e=>{try{importedRows=parseCSV(e.target.result);renderImportPreview();showToast('‚úÖ '+importedRows.length+' questions loaded!')}catch(err){showToast('‚ùå '+err.message)}};
  reader.readAsText(file);
}

async function previewSheet(){
  const url=document.getElementById('sheetUrl').value.trim();
  if(!url){showToast('Paste your Google Sheet CSV URL!');return}
  const btn=document.getElementById('previewBtn');btn.disabled=true;btn.textContent='‚è≥ Fetching‚Ä¶';
  document.getElementById('importPreviewWrap').style.display='none';
  document.getElementById('importBtn').style.display='none';

  const proxies=[u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u),u=>'https://corsproxy.io/?'+encodeURIComponent(u),u=>u];
  let csv=null;
  for(const proxy of proxies){
    try{const res=await fetch(proxy(url),{headers:{'Accept':'text/csv,text/plain,*/*'},mode:'cors'});if(res.ok){csv=await res.text();if(csv&&csv.includes('subject')&&csv.includes(','))break}}catch(e){}
  }
  if(!csv||!csv.includes('subject')){showToast('‚ùå Could not fetch. Use CSV File Upload instead.');btn.disabled=false;btn.textContent='üëÅ Preview from URL';return}
  try{importedRows=parseCSV(csv);renderImportPreview();showToast('‚úÖ '+importedRows.length+' questions loaded!')}catch(e){showToast('‚ùå '+e.message)}
  btn.disabled=false;btn.textContent='üëÅ Preview from URL';
}

function parseCSV(csv){
  const lines=csv.trim().split('\n').map(l=>l.trim()).filter(Boolean);
  if(lines.length<2)throw new Error('Sheet empty or no data rows.');
  const headers=lines[0].split(',').map(h=>h.trim().toLowerCase().replace(/"/g,''));
  const required=['subject','chapter','topic','difficulty','question','optiona','optionb','optionc','optiond','correct'];
  const missing=required.filter(r=>!headers.includes(r));
  if(missing.length)throw new Error('Missing columns: '+missing.join(', '));
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const vals=splitCSVLine(lines[i]),row={};
    headers.forEach((h,idx)=>row[h]=(vals[idx]||'').trim().replace(/^"|"$/g,''));
    const q={subject:normalizeSubject(row['subject']),chapter:row['chapter'],topic:row['topic'],difficulty:row['difficulty']||'Medium',question:row['question'],options:[row['optiona'],row['optionb'],row['optionc'],row['optiond']],correct:'ABCD'.indexOf(row['correct'].toUpperCase()),explanation:row['explanation']||'',createdAt:Date.now(),_rowNum:i+1,_errors:[]};
    if(!q.subject)q._errors.push('no subject');if(!q.chapter)q._errors.push('no chapter');if(!q.topic)q._errors.push('no topic');if(!q.question)q._errors.push('no question');if(q.options.some(o=>!o))q._errors.push('missing option(s)');if(q.correct===-1)q._errors.push('correct must be A/B/C/D');
    rows.push(q);
  }
  return rows;
}

function splitCSVLine(line){const r=[];let c='',inQ=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"')inQ=!inQ;else if(ch===','&&!inQ){r.push(c);c=''}else c+=ch}r.push(c);return r}

async function renderImportPreview(){
  const valid=importedRows.filter(r=>!r._errors.length),invalid=importedRows.filter(r=>r._errors.length);
  if(!allQuestions.length)await loadQuestions();
  const existing=new Set(allQuestions.map(q=>q.question.trim().toLowerCase()));
  let dupCount=0;valid.forEach(r=>{r._isDup=existing.has(r.question.trim().toLowerCase());if(r._isDup)dupCount++});

  document.getElementById('previewCount').textContent=importedRows.length;
  document.getElementById('dupWarning').style.display=dupCount?'':'none';
  document.getElementById('dupWarning').textContent='‚ö† '+dupCount+' duplicate'+(dupCount>1?'s':'');
  document.getElementById('errorCount').style.display=invalid.length?'':'none';
  document.getElementById('errorCount').textContent='‚úï '+invalid.length+' error'+(invalid.length>1?'s':'');

  document.getElementById('importPreviewBody').innerHTML=importedRows.map(r=>{
    const hasErr=r._errors.length>0,isDup=r._isDup;
    const status=hasErr?`<span style="color:var(--red);font-size:.75rem;font-weight:700">‚úï ${r._errors.join(', ')}</span>`:isDup?`<span style="color:#856404;font-size:.75rem;font-weight:700">‚ö† Dup</span>`:`<span style="color:var(--green);font-size:.75rem;font-weight:700">‚úì Ready</span>`;
    const cl=r.correct>=0?'ABCD'[r.correct]:'?';
    return `<tr style="${hasErr?'opacity:.5':''}"><td style="color:var(--text-muted)">${r._rowNum}</td><td><span class="badge badge-olive">${r.subject||'‚Äì'}</span></td><td>${r.chapter||'‚Äì'}<br><span style="color:var(--text-muted);font-size:.7rem">${r.topic||'‚Äì'}</span></td><td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.question||'‚Äì'}</td><td style="font-weight:700;color:var(--olive)">${cl}</td><td>${status}</td></tr>`;
  }).join('');

  document.getElementById('importPreviewWrap').style.display='';
  const toUpload=valid.filter(r=>!r._isDup).length;
  document.getElementById('importBtn').style.display=toUpload?'':'none';
  document.getElementById('importBtn').textContent=`‚¨Ü Upload ${toUpload} New Question${toUpload!==1?'s':''} to Firebase`;
  document.getElementById('clearImportBtn').style.display='';
}

async function importToFirebase(){
  const toUpload=importedRows.filter(r=>!r._errors.length&&!r._isDup);
  if(!toUpload.length){showToast('No new questions!');return}
  const btn=document.getElementById('importBtn');btn.disabled=true;
  const wrap=document.getElementById('importProgressWrap'),bar=document.getElementById('importProgressBar'),lbl=document.getElementById('importProgressLabel'),pct=document.getElementById('importProgressPct');
  wrap.style.display='';document.getElementById('importResultSummary').style.display='none';
  let done=0,failed=0;
  for(const q of toUpload){
    try{const{_rowNum,_errors,_isDup,...clean}=q;const ref=await window._FB.addDoc(window._FB.collection(window._FB.db,'questions'),clean);allQuestions.push({id:ref.id,...clean});done++}catch(e){failed++}
    const p=Math.round(((done+failed)/toUpload.length)*100);bar.style.width=p+'%';pct.textContent=p+'%';lbl.textContent=`Uploading‚Ä¶ ${done+failed}/${toUpload.length}`;
  }
  bar.style.width='100%';lbl.textContent='Done!';pct.textContent='100%';
  const sum=document.getElementById('importResultSummary');sum.style.display='';
  sum.innerHTML=`<span style="color:var(--green);font-weight:700">‚úÖ ${done} uploaded!</span>${failed?` <span style="color:var(--red);font-weight:700">‚ùå ${failed} failed</span>`:''}`;
  btn.disabled=false;btn.textContent='‚úÖ Complete';renderQList();showToast(`‚úÖ ${done} questions imported!`);
}

function clearImport(){
  importedRows=[];
  try{document.getElementById('sheetUrl').value=''}catch(e){}
  try{document.getElementById('csvFileInput').value=''}catch(e){}
  document.getElementById('importPreviewWrap').style.display='none';
  document.getElementById('importProgressWrap').style.display='none';
  document.getElementById('importBtn').style.display='none';
  document.getElementById('clearImportBtn').style.display='none';
  document.getElementById('importBtn').textContent='‚¨Ü Upload to Firebase';
}

/* SAVE QUESTION */
async function saveQuestion(){
  const q={subject:document.getElementById('aSubject').value,difficulty:document.getElementById('aDiff').value,chapter:document.getElementById('aChapter').value.trim(),topic:document.getElementById('aTopic').value.trim(),question:document.getElementById('aQuestion').value.trim(),options:[document.getElementById('opt0').value.trim(),document.getElementById('opt1').value.trim(),document.getElementById('opt2').value.trim(),document.getElementById('opt3').value.trim()],correct:document.querySelector('input[name="correctOpt"]:checked').value,explanation:document.getElementById('aExplanation').value.trim()};
  if(!q.chapter||!q.topic||!q.question||q.options.some(o=>!o)){showToast('Fill all fields!');return}
  const btn=document.getElementById('saveQBtn');btn.disabled=true;btn.textContent='Saving‚Ä¶';
  try{const ref=await window._FB.addDoc(window._FB.collection(window._FB.db,'questions'),q);allQuestions.push({id:ref.id,...q,subject:normalizeSubject(q.subject)});['aChapter','aTopic','aQuestion','aExplanation'].forEach(id=>document.getElementById(id).value='');['opt0','opt1','opt2','opt3'].forEach(id=>document.getElementById(id).value='');showToast('‚úÖ Question saved!')}
  catch(e){showToast('‚ùå '+e.message)}btn.disabled=false;btn.textContent='üíæ Save Question';
}
async function renderQList(){
  if(!allQuestions.length)await loadQuestions();
  const fs=document.getElementById('filterSubj').value,fd=document.getElementById('filterDiff').value;
  let qs=[...allQuestions];if(fs)qs=qs.filter(q=>q.subject===fs);if(fd)qs=qs.filter(q=>q.difficulty===fd);
  document.getElementById('qCount').textContent=qs.length;
  document.getElementById('qListBody').innerHTML=qs.map((q,i)=>`<tr><td style="color:var(--text-muted)">${i+1}</td><td><span class="badge badge-olive">${q.subject}</span></td><td>${q.chapter}<br><span style="font-size:.7rem;color:var(--text-muted)">${q.topic}</span></td><td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${q.question}</td><td><span class="badge badge-khaki">${q.difficulty||'‚Äî'}</span></td><td><button class="btn-danger-sm" onclick="deleteQuestion('${q.id}')">üóë</button></td></tr>`).join('')||'<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:1.5rem">No questions</td></tr>';
}
async function deleteQuestion(id){if(!confirm('Delete?'))return;await window._FB.deleteDoc(window._FB.doc(window._FB.db,'questions',id));allQuestions=allQuestions.filter(q=>q.id!==id);renderQList();showToast('Deleted.')}

/* SAVE NOTE */
function insMd(before,after){const ta=document.getElementById('nContent'),s=ta.selectionStart,e=ta.selectionEnd,sel=ta.value.substring(s,e);ta.value=ta.value.substring(0,s)+before+sel+after+ta.value.substring(e);ta.focus();ta.selectionStart=s+before.length;ta.selectionEnd=s+before.length+sel.length;updatePreview()}
function updatePreview(){
  const md=document.getElementById('nContent').value,el=document.getElementById('editorPreview');
  if(!md.trim()){el.innerHTML='<div class="empty-state"><div class="empty-icon">‚úèÔ∏è</div>Start typing‚Ä¶</div>';return}
  el.innerHTML=renderMd(md);
  renderMathInElement(el,{delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false},{left:'\\[',right:'\\]',display:true}],throwOnError:false});
}
async function saveNote(){
  const data={class:document.getElementById('nClass').value,subject:document.getElementById('nSubject').value,chapter:document.getElementById('nChapter').value.trim(),topic:document.getElementById('nTopic').value.trim(),title:document.getElementById('nTitle').value.trim(),content:document.getElementById('nContent').value,order:parseInt(document.getElementById('nOrder').value)||1,updatedAt:Date.now()};
  if(!data.chapter||!data.topic||!data.title||!data.content){showToast('Fill all fields!');return}
  const btn=document.getElementById('saveNoteBtn');btn.disabled=true;btn.textContent='Saving‚Ä¶';
  const noteId=document.getElementById('editingNoteId').value;
  try{
    if(noteId){await window._FB.updateDoc(window._FB.doc(window._FB.db,'notes',noteId),data);const idx=allNotes.findIndex(n=>n.id===noteId);if(idx>=0)allNotes[idx]={...allNotes[idx],...data};showToast('‚úÖ Updated!')}
    else{data.createdAt=Date.now();const ref=await window._FB.addDoc(window._FB.collection(window._FB.db,'notes'),data);allNotes.push({id:ref.id,...data});showToast('‚úÖ Saved!')}
    clearNoteEditor();renderNotesList();
  }catch(e){showToast('‚ùå '+e.message)}btn.disabled=false;btn.textContent='üíæ Save Note';
}
function clearNoteEditor(){['nChapter','nTopic','nTitle','nContent'].forEach(id=>document.getElementById(id).value='');document.getElementById('nOrder').value='1';document.getElementById('editingNoteId').value='';document.getElementById('editingLabel').style.display='none';document.getElementById('editorPreview').innerHTML='<div class="empty-state"><div class="empty-icon">‚úèÔ∏è</div>Start typing‚Ä¶</div>'}
function editNote(id){
  const n=allNotes.find(x=>x.id===id);if(!n)return;
  document.getElementById('nClass').value=n.class;document.getElementById('nSubject').value=n.subject;
  document.getElementById('nChapter').value=n.chapter;document.getElementById('nTopic').value=n.topic;
  document.getElementById('nTitle').value=n.title;document.getElementById('nContent').value=n.content||'';
  document.getElementById('nOrder').value=n.order||1;document.getElementById('editingNoteId').value=id;
  document.getElementById('editingLabel').style.display='';updatePreview();showPage('admin');adminTab('addn');
}
async function renderNotesList(){
  await loadNotes();const fc=document.getElementById('filterNoteClass').value,fs=document.getElementById('filterNoteSubj').value;
  let ns=[...allNotes];if(fc)ns=ns.filter(n=>n.class===fc);if(fs)ns=ns.filter(n=>n.subject===fs);
  ns.sort((a,b)=>`${a.class}${a.subject}${a.chapter}${a.order}`.localeCompare(`${b.class}${b.subject}${b.chapter}${b.order}`));
  document.getElementById('noteCount').textContent=ns.length;
  document.getElementById('notesListBody').innerHTML=ns.map((n,i)=>`<tr><td style="color:var(--text-muted)">${i+1}</td><td><span class="badge badge-olive">${n.class}</span></td><td><span class="badge badge-khaki">${n.subject}</span></td><td>${n.chapter}<br><span style="font-size:.7rem;color:var(--text-muted)">${n.topic}</span></td><td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${n.title}</td><td style="white-space:nowrap"><button class="btn-sm" onclick="editNote('${n.id}')" style="padding:4px 10px;font-size:.75rem;margin-right:3px">‚úèÔ∏è</button><button class="btn-danger-sm" onclick="deleteNote('${n.id}')">üóë</button></td></tr>`).join('')||'<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:1.5rem">No notes</td></tr>';
}
async function deleteNote(id){if(!confirm('Delete note?'))return;await window._FB.deleteDoc(window._FB.doc(window._FB.db,'notes',id));allNotes=allNotes.filter(n=>n.id!==id);renderNotesList();showToast('Deleted.')}

/* USERS */
async function renderUsers(){
  const snap=await window._FB.getDocs(window._FB.collection(window._FB.db,'users'));
  document.getElementById('usersBody').innerHTML=snap.docs.map(d=>{const u=d.data(),sc=u.scores||[],avg=sc.length?Math.round(sc.reduce((a,b)=>a+b.pct,0)/sc.length)+'%':'‚Äì',best=sc.length?Math.max(...sc.map(s=>s.pct))+'%':'‚Äì';return `<tr><td><strong>${u.name}</strong>${u.isAdmin?' üõ°Ô∏è':''}</td><td>${u.email}</td><td>${sc.length}</td><td>${avg}</td><td>${best}</td></tr>`}).join('');
}

/* ‚ïê‚ïê UTILS ‚ïê‚ïê */
function esc(s){return(s||'').replace(/'/g,"\\'")}
function timeAgo(ts){if(!ts)return'recently';const s=Math.floor((Date.now()-ts)/1000);if(s<60)return'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';if(s<604800)return Math.floor(s/86400)+'d ago';return new Date(ts).toLocaleDateString('en-IN')}
</script>
</body>
</html>
